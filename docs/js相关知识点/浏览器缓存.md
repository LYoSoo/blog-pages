### 浏览器缓存

​		浏览器与服务器的通信方式是应答模式。 浏览器发起HTTP请求 —— 服务器响应该请求，浏览器第一次向服务器发起请求后拿到请求结果，会根据响应报文中的HTTP头的缓存标识，决定是否进行缓存，是则将请求结果和缓存标识存入浏览器缓存中。

​		**强缓存和协商缓存最大的区别就是是否发起了HTTP请求==> 强缓存命中不需要发送HTTP请求，协商缓存都要发送HTTP请求，命中状态码为304，未命中状态码为200。**

​		**强缓存命中了是不需要发起HTTP请求，直接从缓存中拿结果**

​		**协商缓存是根据请求头向服务端确认是否命中，命中请求状态变为304并从缓存中取，未命中从服务端获取，状态为200**

![第一次访问](http://175.24.187.2:12345/cache/cache1.png)

+ 浏览器每次发起请求之前都会先从浏览器缓存中查找请求结果以及缓存标识
+ 浏览器每次拿到的返回结果都会将该结果和缓存表示存入浏览器缓存中

浏览器缓存分为强缓存和协商缓存。

#### 强缓存

主要分为三种情况

+ 不存在缓存结果和缓存标识（第一次发起请求）

![第一次访问](http://175.24.187.2:12345/cache/cache2.png)

+ 存在缓存结果和缓存标识，但是已经失效，使用协商缓存

![第一次访问](http://175.24.187.2:12345/cache/cache3.png)

+ 存在缓存结果和缓存标识，且并未失效，则命中强缓存

![第一次访问](http://175.24.187.2:12345/cache/cache4.png)

#### 强缓存控制字段

**Expires** 是HTTP1.0控制缓存的字段，值是 服务器返回的请求结果的到期时间，再次发起请求的时候如果客户端时间小于该时间，则直接使用缓存**（弊端：服务器时间和本地时间有可能存在差异导致一直使用缓存或者一直无法使用缓存）**

**Cache-control** 是HTTP1.1中控制缓存的字段， 主要分为以下配置项

> + max-age = 60*1000		**常用，相对时间，多久之后失效**
> + no-cache                           **常用，客户端缓存内容，是否使用由协商缓存决定**
> + no-store                            所有内容都不缓存（包括强制缓存/协商缓存）
> + public                                所有内容都被缓存（包括客户端和代理服务器）
> + private                              只有客户端可以缓存   Cache-Control 的默认值

**当我们命中了缓存，在浏览器的调试工具中能够在size 一栏中看到缓存来自哪里（ from memory cache 内存缓存 、 from disk cache 硬盘缓存）**

+ 内存缓存两个特点快速读取和时效性：
  + 快速读取：解析后的文件直接放入进程的内存中，占据进程中的一部分内存，用到时快去读取
  + 失效性：一旦该进程关闭，该进程的内存被清空（关闭浏览器标签）
+ 硬盘缓存：将缓存写入硬盘中，需要时从硬盘中读取并解析，相较于内存缓存慢一些

#### 协商缓存

​		协商缓存是当强缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器决定是否使用协商缓存的过程。

+ 命中协商缓存，状态码返回304，直接从缓存中读取数据。

![第一次访问](http://175.24.187.2:12345/cache/cache5.png)

+ 未命中协商缓存，返回200，并服务器返回请求数据。

![第一次访问](http://175.24.187.2:12345/cache/cache6.png)

##### 协商缓存控制字段

**Last-Modified / If-Modified-Since** ： Last-Modified 是**服务端返回的该资源文件最后被修改的时间**， If-Modified-Since 是 **客户端请求的时候携带上次请求返回的 Last-Modified**， 通过这个告诉服务端上次请求最后被修改的时间，服务端发现 If-Modified-Since 字段会与服务端资源最后修改的时间进行对比，如果服务器的资源最后被修改的时间大于 If-Modified-Since 则重新返回资源，状态码为200，否则返回状态码304，表示资源未更新，可以继续使用缓存文件。 **(Last-Modified精确到秒级别，存在一定的误差)**

**Etag / If-None-Match**： Etag是服务器响应请求时，返回当前资源文件的唯一标识符， 客户端请求的时候通过If-None-Match 带着上一次的 Etag, 服务端接到 Etag 字段的时候，会与该资源在服务器的 Etag 进行比对，如果相等，则返回304，可以使用缓存，如果不相等，返回200 以及新的资源文件。

**Etag生成： 在nginx中是根据响应请求的 `Last-Modified 与 Content-length` 转16进制后拼接而成的。**

```javascript
	new Date(parseInt("606677d5",16)*1000);			//last-modified
	parseInt("6fc37", 16);							//content-length
```



#### 总结

强制缓存优先于协商缓存进行，若强制缓存(Expires和Cache-Control)生效则直接使用缓存，若不生效则进行协商缓存(Last-Modified / If-Modified-Since和Etag / If-None-Match)，协商缓存由服务器决定是否使用缓存，若协商缓存失效，那么代表该请求的缓存失效，重新获取请求结果，再存入浏览器缓存中；生效则返回304，继续使用缓存，主要过程如下：

![第一次访问](http://175.24.187.2:12345/cache/cache7.png)
